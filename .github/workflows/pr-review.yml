name: PR Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review (optional)'
        required: false
        type: number

env:
  REVIEW_DIR: /tmp/review-reports

jobs:
  # Fast checks - run in parallel, must pass
  lint:
    name: Lint & Format
    runs-on: [self-hosted, Linux, X64, recall-pipeline]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Python Lint (Ruff)
        continue-on-error: true
        run: |
          uv run ruff check agents/ tests/ --output-format=github || echo "::warning::Ruff found issues"

      - name: Rust Format Check
        continue-on-error: true
        working-directory: capture
        run: |
          cargo fmt --all -- --check || echo "::warning::Rust formatting issues"

      - name: Rust Clippy
        continue-on-error: true
        working-directory: capture
        run: |
          cargo clippy --workspace -- -D warnings 2>&1 | head -50 || echo "::warning::Clippy warnings"

  # Security scan - can run in parallel
  security:
    name: Security Scan
    runs-on: [self-hosted, Linux, X64, recall-pipeline]
    outputs:
      report_path: ${{ steps.scan.outputs.report_path }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Security Scan
        id: scan
        run: |
          mkdir -p ${{ env.REVIEW_DIR }}
          chmod +x .github/scripts/review/security-scan.sh
          .github/scripts/review/security-scan.sh . ${{ env.REVIEW_DIR }}/security.md || true
          echo "report_path=${{ env.REVIEW_DIR }}/security.md" >> $GITHUB_OUTPUT

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: ${{ env.REVIEW_DIR }}/security.md
          retention-days: 7

  # Code review - needs full diff context
  code-review:
    name: AI Code Review
    runs-on: [self-hosted, Linux, X64, recall-pipeline]
    outputs:
      report_path: ${{ steps.review.outputs.report_path }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Run Code Review Agent
        id: review
        run: |
          mkdir -p ${{ env.REVIEW_DIR }}
          chmod +x .github/scripts/review/code-review-agent.sh

          # Determine base ref
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="origin/${{ github.base_ref }}"
            HEAD_REF="${{ github.sha }}"
          else
            BASE_REF="origin/main"
            HEAD_REF="HEAD"
          fi

          .github/scripts/review/code-review-agent.sh "$BASE_REF" "$HEAD_REF" ${{ env.REVIEW_DIR }}/code-review.md || true
          echo "report_path=${{ env.REVIEW_DIR }}/code-review.md" >> $GITHUB_OUTPUT

      - name: Upload Code Review Report
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: ${{ env.REVIEW_DIR }}/code-review.md
          retention-days: 7

  # Run tests
  test:
    name: Tests
    runs-on: [self-hosted, Linux, X64, recall-pipeline]
    steps:
      - uses: actions/checkout@v4

      - name: Run Python Tests
        run: |
          uv sync --extra dev
          uv run pytest tests/ -v --tb=short

  # Aggregate reports and post comment
  report:
    name: Post Review Report
    runs-on: [self-hosted, Linux, X64, recall-pipeline]
    needs: [lint, security, code-review, test]
    if: always() && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Download Security Report
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: ${{ env.REVIEW_DIR }}
        continue-on-error: true

      - name: Download Code Review Report
        uses: actions/download-artifact@v4
        with:
          name: code-review-report
          path: ${{ env.REVIEW_DIR }}
        continue-on-error: true

      - name: Aggregate Reports
        id: aggregate
        run: |
          mkdir -p ${{ env.REVIEW_DIR }}
          chmod +x .github/scripts/review/report-aggregator.sh

          CODE_REVIEW="${{ env.REVIEW_DIR }}/code-review.md"
          SECURITY="${{ env.REVIEW_DIR }}/security.md"

          [[ -f "$CODE_REVIEW" ]] || CODE_REVIEW=""
          [[ -f "$SECURITY" ]] || SECURITY=""

          .github/scripts/review/report-aggregator.sh "$CODE_REVIEW" "$SECURITY" "" ${{ env.REVIEW_DIR }}/final-report.md

          # Prepare for PR comment (escape for JSON)
          REPORT=$(cat ${{ env.REVIEW_DIR }}/final-report.md)
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        uses: actions/github-script@v7
        env:
          REPORT: ${{ steps.aggregate.outputs.report }}
        with:
          script: |
            const report = process.env.REPORT;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.body.includes('<!-- AI-REVIEW-BOT -->')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  # Summary job status
  summary:
    name: Review Summary
    runs-on: [self-hosted, Linux, X64, recall-pipeline]
    needs: [lint, security, code-review, test, report]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Review | ${{ needs.code-review.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Report | ${{ needs.report.result }} |" >> $GITHUB_STEP_SUMMARY
