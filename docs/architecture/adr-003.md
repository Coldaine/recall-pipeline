---
last_edited: 2026-02-17
editor: Antigravity (Claude-3.5-Sonnet)
user: Coldaine
status: ready
version: 1.1.0
subsystem: architecture
tags: [adr, capture, screenpipe, rewrite]
doc_type: adr
---


# ADR-003: Capture Rewrite from Screenpipe Source

## Status
**Accepted** (2026-02-14)

## Context
The `recall-capture` crate was originally a clean-room rewrite of `screenpipe-vision`. This rewrite:
- Lacked robust error recovery (monitor handle staleness).
- Used inefficient full-resolution pixel diffs instead of screenpipe's optimized `FrameComparer` (downscale → hash → histogram).
- Had no force-capture safety valve, risking silent pipeline failures.
- Failed the `test_live_hardware_capture` integration test (0 frames captured).

Meanwhile, `screenpipe-vision` has battle-tested capture code with years of production hardening.

## Decision
**Port the relevant capture code directly from `screenpipe-vision`** rather than continuing the clean-room rewrite.

A full clone of `mediar-ai/screenpipe` is maintained at `_reference/screenpipe/` (git-ignored) for cherry-picking.

## Alternatives Considered

### 1. Continue clean-room rewrite
- **Pro**: Full control, no upstream baggage.
- **Con**: Reinventing solved problems. The live test already failed. Months of hardening ahead.

### 2. Fork screenpipe and strip down
- **Pro**: Full git history preserved.
- **Con**: Drags in ~19,850 lines of irrelevant code (audio, server, events, integrations). Already audited and rejected in `screenpipe-crate-audit.md`.

### 3. Port relevant code (CHOSEN)
- **Pro**: Get the hardened capture loop, frame comparison, and error recovery. Discard audio, server, OCR inline processing.
- **Con**: Manual extraction effort. Must adapt to our types (`CaptureMessage`, `PipelineMetrics`, `ShutdownSignal`).

## Consequences
- `_reference/screenpipe/` must be kept up to date periodically.
- Ported code must be adapted to our Postgres-only, lazy-processing architecture.
- No dependency on screenpipe crates at runtime; this is a one-time code extraction.
